name: 微调 Qwen3-0.6B 高中学习助手（FastChat + LoRA）
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  train-qwen-lora:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      # 步骤 1：拉取仓库代码
      - name: 拉取代码
        uses: actions/checkout@v4

      # 步骤 2：配置 Python 3.10（纯 Python 环境）
      - name: 配置 Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # 步骤 3：安装系统基础依赖
      - name: 安装系统依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc g++ make libcupti-dev

      # 步骤 4：安装 PyTorch（带 CUDA 11.8）
      - name: 安装 PyTorch + CUDA 11.8
        run: |
          pip install --upgrade pip
          pip install torch==2.1.0 torchvision==0.16.0 torchaudio==2.1.0 --index-url https://download.pytorch.org/whl/cu118

      # 步骤 5：安装依赖（升级 huggingface-hub 确保兼容性）
      - name: 安装 FastChat 及训练工具
        run: |
          pip install -e .
          # 升级 huggingface-hub 到支持断点续传的版本
          pip install huggingface-hub==0.23.4 transformers==4.37.2 accelerate==0.27.1 peft==0.8.2 datasets==2.14.6
          pip install sentencepiece==0.1.99
          # 验证 CUDA 和依赖
          python -c "import torch; print('CUDA 可用：', torch.cuda.is_available()); print('CUDA 版本：', torch.version.cuda)"
          python -c "import huggingface_hub; print('huggingface-hub 版本：', huggingface_hub.__version__)"

      # 步骤 6：登录 Hugging Face Hub
      - name: 登录 Hugging Face Hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          huggingface-cli login --token $HF_TOKEN

      # 步骤 7：下载 Qwen3-0.6B 模型（移除 --max-workers，添加断点续传）
      - name: 下载 Qwen3-0.6B 模型
        run: |
          huggingface-cli download Qwen/Qwen3-0.6B --local-dir ./models/Qwen3-0.6B --local-dir-use-symlinks False --resume-download --include "*.bin" "*.json" "*.model" "*.py"
          
          # 验证下载结果
          echo "模型目录内容："
          ls -l ./models/Qwen3-0.6B
          du -sh ./models/Qwen3-0.6B
          df -h

      # 步骤 8：执行 LoRA 微调（核心步骤）
      - name: 启动 Qwen3-0.6B LoRA 微调
        run: |
          python -m fastchat.train.train_lora \
            --model_name_or_path ./models/Qwen3-0.6B \
            --data_path ./data/highschool_qa.json \
            --output_dir ./output/Qwen3-0.6B-highschool-lora \
            --per_device_train_batch_size=2 \
            --gradient_accumulation_steps=8 \
            --learning_rate=2e-4 \
            --num_train_epochs=3 \
            --logging_steps=10 \
            --save_steps=100 \
            --fp16=True \
            --lora_r=8 \
            --lora_alpha=16 \
            --lora_dropout=0.05 \
            --target_modules="q_proj,v_proj,k_proj,o_proj,gate_proj,up_proj,down_proj" \
            --peft_model_id ${{ secrets.HF_USERNAME }}/Qwen3-0.6B-highschool-qa \
            --push_to_hub=True \
            --no-flash-attn \
            --load-8bit

      # 步骤 9：推送模型到 Hugging Face
      - name: 推送模型到 Hugging Face Hub
        if: success()
        run: |
          python -m fastchat.model.push_to_hub \
            --model-path ./models/Qwen3-0.6B \
            --lora-path ./output/Qwen3-0.6B-highschool-lora \
            --repo-id ${{ secrets.HF_USERNAME }}/Qwen3-0.6B-highschool-qa \
            --commit-message "FastChat 微调 Qwen3-0.6B 高中助手（最终版）"
